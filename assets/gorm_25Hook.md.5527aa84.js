import{_ as s,c as n,o as a,a as l}from"./app.78cd51cb.js";const i=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[{"level":3,"title":"1.\u5BF9\u8C61\u58F0\u660E\u5468\u671F","slug":"_1-\u5BF9\u8C61\u58F0\u660E\u5468\u671F","link":"#_1-\u5BF9\u8C61\u58F0\u660E\u5468\u671F","children":[]},{"level":3,"title":"Hook","slug":"hook","link":"#hook","children":[]},{"level":3,"title":"2.\u521B\u5EFA\u5BF9\u8C61","slug":"_2-\u521B\u5EFA\u5BF9\u8C61","link":"#_2-\u521B\u5EFA\u5BF9\u8C61","children":[]},{"level":3,"title":"3.\u66F4\u65B0\u5BF9\u8C61","slug":"_3-\u66F4\u65B0\u5BF9\u8C61","link":"#_3-\u66F4\u65B0\u5BF9\u8C61","children":[]},{"level":3,"title":"4.\u5220\u9664\u5BF9\u8C61","slug":"_4-\u5220\u9664\u5BF9\u8C61","link":"#_4-\u5220\u9664\u5BF9\u8C61","children":[]},{"level":3,"title":"5.\u67E5\u8BE2\u5BF9\u8C61","slug":"_5-\u67E5\u8BE2\u5BF9\u8C61","link":"#_5-\u67E5\u8BE2\u5BF9\u8C61","children":[]},{"level":3,"title":"6.\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C","slug":"_6-\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C","link":"#_6-\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C","children":[]}],"relativePath":"gorm/25Hook.md"}'),p={name:"gorm/25Hook.md"},o=l(`<h3 id="_1-\u5BF9\u8C61\u58F0\u660E\u5468\u671F" tabindex="-1">1.\u5BF9\u8C61\u58F0\u660E\u5468\u671F <a class="header-anchor" href="#_1-\u5BF9\u8C61\u58F0\u660E\u5468\u671F" aria-hidden="true">#</a></h3><ul><li><code>Hook</code>\u662F\u5728\u521B\u5EFA\uFF0C\u67E5\u8BE2\uFF0C\u66F4\u65B0\uFF0C\u5220\u9664\u7B49\u64CD\u4F5C\u4E4B\u524D\uFF0C\u4E4B\u540E\u8C03\u7528\u7684\u51FD\u6570\u3002</li><li>\u5982\u679C\u4F60\u5DF2\u7ECF\u4E3A\u6A21\u578B\u5B9A\u4E49\u4E86\u6307\u5B9A\u7684\u65B9\u6CD5\uFF0C\u5B83\u4F1A\u5728\u521B\u5EFA\uFF0C\u66F4\u65B0\uFF0C\u67E5\u8BE2\uFF0C\u5220\u9664\u65F6\u81EA\u52A8\u88AB\u8C03\u7528\u3002\u5982\u679C\u4EFB\u4F55\u56DE\u8C03\u8FD4\u56DE\u9519\u8BEF\uFF0CGORM \u5C06\u505C\u6B62\u540E\u7EED\u7684\u64CD\u4F5C\u5E76\u56DE\u6EDA\u4E8B\u52A1\u3002</li><li>\u94A9\u5B50\u65B9\u6CD5\u7684\u51FD\u6570\u7B7E\u540D\u5E94\u8BE5\u662F<code>func(*gorm.DB) error</code></li></ul><h3 id="hook" tabindex="-1">Hook <a class="header-anchor" href="#hook" aria-hidden="true">#</a></h3><h3 id="_2-\u521B\u5EFA\u5BF9\u8C61" tabindex="-1">2.\u521B\u5EFA\u5BF9\u8C61 <a class="header-anchor" href="#_2-\u521B\u5EFA\u5BF9\u8C61" aria-hidden="true">#</a></h3><ul><li>\u521B\u5EFA\u53EF\u7528\u7684 hook</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u5F00\u59CB\u4E8B\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">BeforeSave</span></span>
<span class="line"><span style="color:#A6ACCD;">BeforeCreate</span></span>
<span class="line"><span style="color:#676E95;">// \u5173\u8054\u524D\u7684save</span></span>
<span class="line"><span style="color:#676E95;">// \u63D2\u5165\u8BB0\u5F55\u81F3 db</span></span>
<span class="line"><span style="color:#676E95;">// \u5173\u8054\u540E\u7684save</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterCreate</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterSave</span></span>
<span class="line"><span style="color:#676E95;">// \u63D0\u4EA4\u6216\u56DE\u6EDA\u4E8B\u52A1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>\u4EE3\u7801\u793A\u4F8B</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BeforeCreate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">UUID </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> uuid</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">u</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsValid</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> errors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">can&#39;t save invalid data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AfterCreate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ID </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Model</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">role</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">admin</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>\u6CE8\u610F\uFF1A\u5728 GORM \u4E2D\u4FDD\u5B58\uFF0C\u5220\u9664\u64CD\u4F5C\u9ED8\u8BA4\u4F1A\u8FD0\u884C\u5728\u4E8B\u52A1\u4E0A\uFF0C\u56E0\u4E3A\u5728\u4E8B\u52A1\u5B8C\u6210\u4E4B\u524D\u8BE5\u4E8B\u52A1\u4E2D\u6240\u6709\u7684\u66F4\u6539\u65F6\u4E0D\u53EF\u89C1\u7684\uFF0C\u5982\u679C\u4F60\u7684\u94A9\u5B50\u8FD4\u56DE\u4E86\u4EFB\u4F55\u9519\u8BEF\uFF0C\u5219\u4FEE\u6539\u5C06\u88AB\u56DE\u6EDA\u3002</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u5728hook\u4E2D\u8FD4\u56DE\u9519\u8BEF\uFF0C\u5219\u6267\u884C\u7684\u8BED\u53E5\u5C06\u5931\u8D25</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AfterCreate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">u</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsValid</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> errors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rollback invalid user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">nil</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_3-\u66F4\u65B0\u5BF9\u8C61" tabindex="-1">3.\u66F4\u65B0\u5BF9\u8C61 <a class="header-anchor" href="#_3-\u66F4\u65B0\u5BF9\u8C61" aria-hidden="true">#</a></h3><ul><li>\u66F4\u65B0\u65F6\u53EF\u7528\u7684 hook</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u5F00\u59CB\u4E8B\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">BeforeSave</span></span>
<span class="line"><span style="color:#A6ACCD;">BeforeUpdate</span></span>
<span class="line"><span style="color:#676E95;">// \u5173\u8054\u524D\u7684 save</span></span>
<span class="line"><span style="color:#676E95;">// \u66F4\u65B0 db</span></span>
<span class="line"><span style="color:#676E95;">// \u5173\u8054\u540E\u7684 save</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterUpdate</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterSave</span></span>
<span class="line"><span style="color:#676E95;">// \u63D0\u4EA4\u6216\u56DE\u6EDA\u4E8B\u52A1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>\u4EE3\u7801\u793A\u4F8B</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BeforeUpdate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">readonly</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    err </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> errors</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">New</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">read only user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// \u5728\u540C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u66F4\u65B0\u6570\u636E</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AfterUpdate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Confirmed </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Model</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">Address</span><span style="color:#89DDFF;">{}).</span><span style="color:#82AAFF;">Where</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user_id = ?</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ID</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">verfied</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_4-\u5220\u9664\u5BF9\u8C61" tabindex="-1">4.\u5220\u9664\u5BF9\u8C61 <a class="header-anchor" href="#_4-\u5220\u9664\u5BF9\u8C61" aria-hidden="true">#</a></h3><ul><li>\u5220\u9664\u65F6\u53EF\u7528<code>hook</code></li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u5F00\u59CB\u4E8B\u52A1</span></span>
<span class="line"><span style="color:#A6ACCD;">BeforeDelete</span></span>
<span class="line"><span style="color:#676E95;">// \u5220\u9664 db \u4E2D\u7684\u6570\u636E</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterDelete</span></span>
<span class="line"><span style="color:#676E95;">// \u63D0\u4EA4\u6216\u56DE\u6EDA\u4E8B\u52A1</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>\u4EE3\u7801\u793A\u4F8B</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u5728\u540C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\u66F4\u65B0\u6570\u636E</span></span>
<span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AfterDelete</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Confirmed </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Model</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">Address</span><span style="color:#89DDFF;">{}).</span><span style="color:#82AAFF;">Where</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user_id = ?</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ID</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">invalid</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_5-\u67E5\u8BE2\u5BF9\u8C61" tabindex="-1">5.\u67E5\u8BE2\u5BF9\u8C61 <a class="header-anchor" href="#_5-\u67E5\u8BE2\u5BF9\u8C61" aria-hidden="true">#</a></h3><ul><li>\u67E5\u8BE2\u65F6\u53EF\u7528\u7684 hook</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#676E95;">// \u4ECE db \u4E2D\u52A0\u8F7D\u6570\u636E</span></span>
<span class="line"><span style="color:#676E95;">// Preloading (eager loading)</span></span>
<span class="line"><span style="color:#A6ACCD;">AfterFind</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>\u4EE3\u7801\u793A\u4F8B</li></ul><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#89DDFF;">func</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">u </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AfterFind</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">err </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MemberShip </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    u</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MemberShip </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_6-\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C" tabindex="-1">6.\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C <a class="header-anchor" href="#_6-\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C" aria-hidden="true">#</a></h3><div class="language-go line-numbers-mode"><button class="copy"></button><span class="lang">go</span><pre><code><span class="line"><span style="color:#89DDFF;">func(</span><span style="color:#A6ACCD;">u  </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">User</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BeforeCreate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tx </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">gorm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DB</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">error</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// \u901A\u8FC7tx.Statement\u4FEE\u6539\u5F53\u524D\u64CD\u4F5C\uFF0C\u4F8B\u5982\uFF1A</span></span>
<span class="line"><span style="color:#A6ACCD;">  tx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Statement</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Select</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Age</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddClause</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">clause</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">OnConflict</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">DoNothing</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// tx\u662F\u5E26\u6709\`NewDB\`\u9009\u9879\u7684\u65B0\u4F1A\u8BDD\u6A21\u5F0F</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// \u57FA\u4E8Etx\u7684\u64CD\u4F5C\u4F1A\u5728\u540C\u4E00\u4E2A\u4E8B\u52A1\u4E2D\uFF0C\u4F46\u4E0D\u4F1A\u5E26\u4E0A\u4EFB\u4F55\u5F53\u524D\u7684\u6761\u4EF6</span></span>
<span class="line"><span style="color:#A6ACCD;">  err </span><span style="color:#89DDFF;">:=</span><span style="color:#A6ACCD;"> tx</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">First</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#A6ACCD;">role</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">name = ?</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Role</span><span style="color:#89DDFF;">).</span><span style="color:#A6ACCD;">Error</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// SELECT * FROM roles WHERE name = &quot;admin&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;">// ...</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> err</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div>`,27),e=[o];function r(c,t,D,F,y,A){return a(),n("div",null,e)}const u=s(p,[["render",r]]);export{i as __pageData,u as default};
